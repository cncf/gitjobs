const v=()=>typeof window<"u",S=()=>window.self!==window.top,y=e=>e instanceof HTMLIFrameElement,E=e=>{"complete"===window.document.readyState?e():window.addEventListener("load",e)},M=(e,t)=>{t(),e.addEventListener("load",t)},T=(e,t)=>{const n="complete"===e.contentWindow?.document.readyState;return"about:blank"!==e.src&&"about:blank"!==e.contentWindow?.location.href&&n?t():e.addEventListener("load",t)},C=()=>({offsetSize:0,checkOrigin:!0,enableLegacyLibSupport:!1}),B=e=>{try{return new URL(e.src).origin===window.location.origin}catch{return!1}},k=e=>{try{const t=new URL(e.src).origin;if("about:blank"!==t)return t}catch{}return null},D=e=>(Object.keys(e).forEach(t=>{void 0===e[t]&&delete e[t]}),e),p=e=>{const{height:t,width:n}=e.getBoundingClientRect();return{height:Math.ceil(t),width:Math.ceil(n)}},f=(e,t)=>e?t?e.querySelector(t):e.documentElement:null,L=(e,t)=>{e&&(t.bodyPadding&&(e.body.style.padding=t.bodyPadding),t.bodyMargin&&(e.body.style.margin=t.bodyMargin))},m=e=>e<=100?100:e<=120?1e3:1e4,W=()=>"[iFrameSizer]ID:0:false:false:32:true:true::auto:::0:false:child:auto:true:::true:::false";function A(e){if("string"!=typeof e.data||!e.data.startsWith("[iFrameSizer]")||!e.data.endsWith("mutationObserver")&&!e.data.endsWith("resizeObserver"))return null;const[t,n]=e.data.split(":"),r=+n;return r>0?r:null}const b=_();let l=[];const J=(e,t)=>{if(!v())return[];const n={...C(),...D(e??{})},r=H(t),i=P(n,r);return r.map(e=>{const t={iframe:e,settings:n,interactionState:{isHovered:!1},initContext:{isInitialized:!1,retryAttempts:0}},r=x(t,i);return l.push(t),{unsubscribe:()=>{r(),l=l.filter(t=>t.iframe!==e)}}})};function H(e){return"string"==typeof e?Array.from(document.querySelectorAll(e)).filter(y):e?y(e)?[e]:[]:Array.from(document.getElementsByTagName("iframe"))}function P(e,t){if(Array.isArray(e.checkOrigin))return e.checkOrigin;if(!e.checkOrigin)return[];const n=[];for(const e of t){const t=k(e);t&&n.push(t)}return n}function x(e,t){const n=B(e.iframe)?N(e):F(e,t),r=U(e);return()=>{n(),r()}}function F(e,t){const{iframe:n,initContext:r,settings:{checkOrigin:i,enableLegacyLibSupport:o,targetElementSelector:s,bodyPadding:a,bodyMargin:c}}=e,d=r=>{const s=!i||t.includes(r.origin);if(n.contentWindow===r.source&&s){if("iframe-resized"===r.data?.type){const{height:t}=r.data;return void(t&&g({newHeight:t,registeredElement:e}))}if(o){const t=A(r);return void(null!==t&&g({newHeight:t,registeredElement:e}))}}};window.addEventListener("message",d);const u=o?W():{type:"iframe-child-init",targetElementSelector:s,bodyPadding:a,bodyMargin:c},l=()=>{M(n,()=>n.contentWindow?.postMessage(u,"*")),r.retryAttempts++,r.retryTimeoutId=window.setTimeout(l,m(r.retryAttempts))};return l(),()=>window.removeEventListener("message",d)}function N(e){const{iframe:t,settings:n}=e,{targetElementSelector:r}=n;let i=0;const o=()=>{const e=f(t.contentDocument,r);if(!t.contentDocument||!e)return i++,setTimeout(o,m(i));L(t.contentDocument,n),b().observe(e)};return T(t,o),()=>{const e=f(t.contentDocument,r);e&&b().unobserve(e),t.removeEventListener("load",o)}}function U({iframe:e,interactionState:t}){const n=()=>{t.isHovered=!0},r=()=>{t.isHovered=!1};return e.addEventListener("mouseenter",n),e.addEventListener("mouseleave",r),()=>{e.removeEventListener("mouseenter",n),e.removeEventListener("mouseleave",r)}}function _(){let e=null;return()=>{if(!e){const t=({target:e})=>{const t=l.find(({iframe:t})=>t.contentDocument===e.ownerDocument);if(!t)return;const{iframe:n,settings:r}=t,i=f(n.contentDocument,r.targetElementSelector);if(!i)return;const{height:o}=p(i);o&&g({newHeight:o,registeredElement:t})};e=new ResizeObserver(e=>e.forEach(t))}return e}}function g({registeredElement:e,newHeight:t}){const{iframe:n,settings:r,interactionState:i,initContext:o}=e;if(o.isInitialized||(o.isInitialized=!0,clearTimeout(o.retryTimeoutId)),!1===r.onBeforeIframeResize?.({iframe:n,settings:{...r},observedHeight:t}))return;const s=n.getBoundingClientRect(),a=t+r.offsetSize;if(n.style.height=`${a}px`,!r.onIframeResize)return;const c={iframe:n,settings:{...r},interactionState:{...i},previousRenderState:{rect:s},nextRenderState:{rect:n.getBoundingClientRect()}};r.onIframeResize(c)}const $=V();let z=!1;function q(){!v()||!S()||window.addEventListener("message",e=>{"iframe-child-init"===e.data?.type&&E(()=>I(e))})}function I(e,t=0){const{targetElementSelector:n,bodyPadding:r,bodyMargin:i}=e.data,o=f(document,n);if(z||window.parent!==e.source)return;if(!o)return setTimeout(()=>I(e,t+1),m(t));L(document,{bodyMargin:i,bodyPadding:r});const s=$();s.disconnect(),s.observe(o),z=!0}function V(){let e=null;return()=>(e||(e=new ResizeObserver(e=>{if(!e[0].target)return;const{height:t,width:n}=p(e[0].target),r={type:"iframe-resized",width:n,height:t};window.parent.postMessage(r,"*")})),e)}q();const K=({previousRenderState:e,nextRenderState:t,iframe:n})=>{document.activeElement===n&&window.scrollBy(0,t.rect.bottom-e.rect.bottom)};export{J as initialize,q as initializeChildListener,K as updateParentScrollOnResize};