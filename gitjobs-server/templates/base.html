<!DOCTYPE html>
<html lang="en"
      class="h-full min-h-dvh has-[div[role='dialog'][data-open='true']]:overflow-hidden">
  <head>
    <title>GitJobs</title>
    <meta name="description"
          content="GitJobs is an open source job board focused on open source job opportunities.">
    <meta name="keywords" content="community, organization, jobs, job">

    {#- OG tags #}
    <meta property="og:type" content="website">
    <meta property="og:title" content="GitJobs">
    <meta property="og:url" content="https://gitjobs.dev/">
    <meta property="og:description"
          content="GitJobs is an open source job board focused on open source job opportunities.">
    <meta property="og:image"
          content="https://gitjobs.dev/static/images/index/gitjobs.png">
    {#- End OG tags  #}

    {#- Twitter tags #}
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="gitjobs.dev">
    <meta property="twitter:url" content="https://gitjobs.dev">
    <meta name="twitter:title" content="GitJobs">
    <meta name="twitter:description"
          content="GitJobs is an open source job board focused on open source job opportunities.">
    <meta name="twitter:image"
          content="https://gitjobs.dev/static/images/index/gitjobs.png">
    {#- End Twitter tags #}

    <link rel="icon"
          href="https://gitjobs.dev/static/images/index/favicon.ico"
          sizes="any">
    <link rel="icon"
          href="https://gitjobs.dev/static/images/index/favicon.svg"
          sizes="any"
          type="image/svg+xml">
    <link rel="apple-touch-icon"
          href="https://gitjobs.dev/static/images/index/apple-touch-icon.png">
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale = 1, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f9fafb" />
    <meta name="htmx-config" content='{"includeIndicatorStyles": false}'>

    <link rel="stylesheet" href="/static/css/styles.css" />
    <link rel="stylesheet" href="/static/vendor/css/easymde.v2.20.0.min.css" />

    <script type="text/javascript" src="/static/vendor/js/htmx.v2.0.7.min.js"></script>
    <script src="/static/vendor/js/easymde.v2.20.0.min.js"></script>
    <script src="/static/vendor/js/sweetalert2.v11.23.0.min.js"></script>

    <script type="text/javascript">
      // Trim string values and filter out empty or "0" entries before HTMX serializes them.
      const removeEmptyValues = (source) => {
        const filteredEntries = [];

        for (const [key, rawValue] of source.entries()) {
          const value = typeof rawValue === "string" ? rawValue.trim() : String(rawValue);
          if (value === "" || value === "0") {
            continue;
          }

          filteredEntries.push([key, typeof rawValue === "string" ? value : rawValue]);
        }

        return filteredEntries;
      };

      // htmx extension to remove empty values from the parameters.
      htmx.defineExtension("no-empty-vals", {
        onEvent: (name, event) => {
          if (name !== "htmx:configRequest") {
            return true;
          }

          const request = event.detail;
          // For GET requests, filter formData directly because HTMX builds URL params from it.
          if (request.verb !== "get" || !request.useUrlParams) {
            return true;
          }

          const filteredParameters = new FormData();
          for (const [key, value] of removeEmptyValues(request.formData)) {
            filteredParameters.append(key, value);
          }

          request.formData = filteredParameters;
          request.parameters = filteredParameters;

          return true;
        },
        encodeParameters: (xhr, parameters, elt) => {
          // For non-GET requests, mutate parameters in place and let HTMX encode normally.
          const filteredEntries = removeEmptyValues(parameters);

          for (const key of [...parameters.keys()]) {
            parameters.delete(key);
          }

          for (const [key, value] of filteredEntries) {
            parameters.append(key, value);
          }

          return null;
        }
      });
    </script>
    <script type="module">
      import {
        getParamFromQueryString,
        shouldDisplayJobModal,
        toggleModalVisibility
      } from '/static/js/common/common.js';

      window.addEventListener("popstate", (event) => {
        const job_id_param = getParamFromQueryString('job_id');
        const modal_preview = document.getElementById('preview-modal');
        if (event.state && event.state.modal_preview !== undefined) {
          if (event.state.modal_preview && modal_preview !== null) {
            const job_id = getParamFromQueryString('job_id');
            if (modal_preview !== null) {
              if (job_id !== modal_preview.dataset.jobId) {
                shouldDisplayJobModal();
              } else {
                toggleModalVisibility('preview-modal', "open");
              }
            }
          } else {
            toggleModalVisibility('preview-modal', "close");
          }
        } else {
          if (modal_preview !== null && modal_preview.dataset.open === "true") {
            toggleModalVisibility('preview-modal', "close");
          }
        }
        const embedCode = document.getElementById('embed-code-modal');
        if (embedCode !== null && embedCode.dataset.open === "true") {
          toggleModalVisibility('embed-code-modal', "close");
        }
        const dropwodnUser = document.getElementById('dropdown-user');
        if (dropwodnUser !== null && !dropwodnUser.classList.contains('hidden')) {
          document.getElementById('dropdown-user').classList.add('hidden');
        }
      });
    </script>

    {# Analytics -#}
    {%- if let Some(analytics) = cfg.analytics -%}
      {# Osano -#}
      {%- if let Some(osano_script_url) = analytics.osano_script_url -%}
        <script src="{{ osano_script_url }}"></script>
      {% endif -%}
      {# End Osano -#}

      {# Google tag (gtag.js) -#}
      {%- if let Some(google_tag_id) = analytics.google_tag_id -%}
        <script src="https://www.googletagmanager.com/gtag/js?id={{ google_tag_id }}"></script>
        <script>
          window.dataLayer = window.dataLayer || [];

          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '{{ google_tag_id }}', {
            'send_page_view': false, // Disable automatic page view tracking
            'transport_type': 'beacon' // Use 'beacon' transport for better reliability
          });
        </script>
        <script>
          // Helper function to build URL
          const buildUrl = (pageLocation) => {
            try {
              return new URL(pageLocation || window.location.href, window.location.href);
            } catch (error) {
              return null;
            }
          }

          (() => {
            let lastVirtualHref = null;

            // Function to build virtual path for job pages
            const buildVirtualPath = (href) => {
              const url = buildUrl(href);
              if (!url) {
                return null;
              }
              const jobId = url.searchParams.get('job_id');
              if (!jobId) {
                const basePath = url.pathname || '/';
                const query = url.search || '';
                return `${basePath}${query}`;
              }
              return `/job/${encodeURIComponent(jobId)}`;
            }

            // Function to get job details from the DOM
            const getJobDetails = (jobId) => {
              if (!jobId) {
                return null;
              }
              const jobButton = document.getElementById(`job-preview-${jobId}`);
              if (!jobButton) {
                return null;
              }
              const {
                jobTitle,
                jobCompany
              } = jobButton.dataset;
              if (!jobTitle && !jobCompany) {
                return null;
              }
              const pageTitle = jobTitle && jobCompany ?
                `${jobCompany} | ${jobTitle} (${jobId})` :
                null;
              return {
                pageTitle,
                jobTitle: jobTitle || null,
                jobCompany: jobCompany || null
              };
            }

            // Emit virtual page views when routes change or modals display jobs
            const sendPageView = (options = {}) => {
              const {
                preserveAttribution = false
              } = options;
              if (typeof window.gtag !== 'function') {
                return;
              }
              const naturalHref = window.location.href;
              const virtualPath = buildVirtualPath(naturalHref);
              if (!virtualPath) {
                return;
              }
              const virtualHref = `${window.location.origin}${virtualPath}`;
              // Avoid sending duplicate page views
              if (virtualHref === lastVirtualHref) {
                return;
              }
              const currentUrl = buildUrl(naturalHref);
              const jobId = currentUrl ? currentUrl.searchParams.get('job_id') : null;
              const referrer = preserveAttribution ?
                document.referrer || undefined :
                lastVirtualHref || document.referrer || undefined;
              const payload = {
                page_title: document.title,
                page_path: virtualPath,
                page_location: preserveAttribution ? naturalHref : virtualHref,
                page_referrer: referrer,
                send_to: '{{ google_tag_id }}'
              };
              if (jobId) {
                const {
                  pageTitle,
                  jobTitle,
                  jobCompany
                } = getJobDetails(jobId) || {};

                payload.page_title = pageTitle || `Job ID: ${jobId}`;
                payload.job_id = jobId;
                payload.job_title = jobTitle || undefined;
                payload.job_company = jobCompany || undefined;
              }

              // Send the page_view event to Google Analytics
              gtag('event', 'page_view', payload);

              lastVirtualHref = virtualHref;
            }

            window.addEventListener('DOMContentLoaded', () => {
              sendPageView({
                preserveAttribution: true
              });
            });

            const originalPushState = history.pushState;
            history.pushState = function(...args) {
              const result = originalPushState.apply(this, args);
              sendPageView();
              return result;
            };

            const originalReplaceState = history.replaceState;
            history.replaceState = function(...args) {
              const result = originalReplaceState.apply(this, args);
              sendPageView();
              return result;
            };

            window.addEventListener('popstate', () => {
              sendPageView();
            });
          })();
        </script>
      {% endif -%}
      {# End Google tag -#}
    {% endif -%}
    {# End Analytics -#}
  </head>
  <body class="flex flex-col min-h-dvh font-inter bg-stone-100 relative"
        hx-get
        hx-trigger="refresh-body">
    <a href="#main-content"
       class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-50 focus:px-4 focus:py-2 focus:bg-primary-600 focus:text-white focus:rounded-md focus:shadow-lg">
      Skip to main content
    </a>
    {% block content -%}
    {% endblock content -%}

    {% if page_id == PageId::JobBoard || page_id == PageId::About -%}
      {# Footer -#}
      {% include "footer.html" -%}
      {# End Footer -#}
    {% endif -%}
  </body>
</html>
